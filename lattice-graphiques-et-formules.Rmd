---
title: "lattice : graphiques et formules"
---

```{r options_communes, include=FALSE}
source("options_communes.R")
```

<div class="important">
Ce chapitre est en cours d'écriture.
</div>

Bien que l'on ait fait le choix de présenter principalement l'extension `ggplot2`{.pkg} plutôt que l'extension `lattice`{.pkg}, celle-ci reste un excellent choix pour la visualisation, notamment, de [panels](http://www.magesblog.com/2013/09/using-planelgroups-in-lattice.html) et de [séries temporelles](http://www.fromthebottomoftheheap.net/2013/10/23/time-series-plots-with-lattice-and-ggplot/). On trouve de [très beaux exemples](https://procomun.wordpress.com/2015/04/14/mapping-flows-in-r-with-data-table-and-lattice/) d'utilisation de `lattice`{.pkg} en ligne, mais un peu moins de documentation, et beaucoup moins d'extensions, que pour `ggplot2`{.pkg}.

On peut trouver en ligne un support de cours détaillé (en anglais) de Deepayan Sarkar (<https://www.isid.ac.in/~deepayan/R-tutorials/labs/04_lattice_lab.pdf>), également l'auteur de l'ouvrage *Lattice: Multivariate Data Visualization with R* (<http://lmdvr.r-forge.r-project.org/>).

## Les bases des graphiques `lattice`{.pkg}

R dispose de deux principaux systèmes graphiques : un système de base contrôlé par le package `graphics`{.pkg} et le système `grid`{.pkg}, sur lequel se basent à la fois les packages `lattice`{.pkg} et `ggplot2`{.pkg}. Ce système fournit les mêmes fonctionnalités de base que `graphics`{.pkg} mais offre une gestion de l'arrangement des objets graphiques plus développée, et surtout la possibilité d'utiliser ce que l'on appelle des *graphiques en treillis*. De plus, les graphiques peuvent être mis à jour très simplement, disposent de thèmes de couleur pré-définis, et offrent un certain degré d'interactivité, avec ou sans le package `plotly`{.pkg}. Enfin, la syntaxe est plus homogène et grandement simplifié, grâce à l'usage de formules.

### De l'intérêt des formules R

Voici par exemple comment afficher la courbe de densité (i.e., la version continue et "lissée" d'un histogramme) de deux séries d'observations définies par les niveaux du facteur `supp` dans le data frame `ToothGrowth`, disponible dans les exemples de base de R. Notons que l'on souhaite également faire apparaître les distributions univariées, un peu à l'image de ce que fournit `rug`{data-pkg="graphics"}. Or cette fonction ne permet pas d'exploiter une variable de groupement, donc il sera nécessaire de gérer tout cela manuellement. Voici les instructions permettant de générer le graphique désiré :

<figure>
```{r}
plot(density(ToothGrowth$len[ToothGrowth$supp == "OJ"]), main = "", xlab = "len", las = 1, lwd = 2, col = "coral")
lines(density(ToothGrowth$len[ToothGrowth$supp == "VC"]), lwd = 2, col = "cornflowerblue")
points(x = ToothGrowth$len[ToothGrowth$supp == "OJ"], 
       y = runif(m = length(ToothGrowth$len[ToothGrowth$supp == "OJ"]),
                 min = -0.001, max = 0.001), col = "coral")
points(x = ToothGrowth$len[ToothGrowth$supp == "VC"], 
       y = runif(m = length(ToothGrowth$len[ToothGrowth$supp == "VC"]),
                 min = -0.001, max = 0.001), col = "cornflowerblue")
legend("top", levels(ToothGrowth$supp), col = c("coral", "cornflowerblue"), lty = 1, bty = "n")
```
<figcaption>Courbes de densité avec les graphiques de base</figcaption>
</figure>

Il y a plusieurs points à retenir dans les instructions ci-dessus : (1) il est nécessaire de définir les deux courbes de densité et les deux distributions univariées, en prenant garde à bien indiquer comment sélectionner les observations (`OJ` ou `VC`) en préfixant systématiquement le nom des variables par le nom du data frame ; (2) la définition des couleurs se fait manuellement et si l'on souhaite changer de thème de couleur, il faudra mettre à jour l'ensemble des instructions, en prenant garde à garder synchronisé les courbes de densité et les nuages de points avec la légende ; et, bien entendu, (3) il est nécessaire de gérer soi-même la légende, ce que signifie se rappeler les couleurs et l'ordre des niveaux du facteur considéré.

Voici le même graphique avec `lattice`{.pkg} :

<figure>
```{r}
library(lattice)
densityplot(~ len, data = ToothGrowth, group = supp, auto.key = TRUE)
```
<figcaption>Courbes de densité avec le package `lattice`</figcaption>
</figure>

Avec `ggplot2`{.pkg}, cela donnerait :

<figure>
```{r}
library(ggplot2)
ggplot(data = ToothGrowth, aes(x = len, color = supp)) +
       geom_line(stat = ”density”) + geom_rug()
```
<figcaption>Courbes de densité avec le package `ggplot2`</figcaption>
</figure>


### Les formules R

Les formules utilisées dans le système `lattice` sont presque identiques à celles retouvées dans les modèles d'analyse de variance ou de régression. En réalité, la notation par formule qu'utilise R est celle proposée par Wilkinson et coll. dans les années 70 pour schématiser la relation entre plusieurs variables dans un plan d'expérience. Plus spécifiquement, l'idée revient à exprimer une relation "fonctionnelle", symbolisée par l'opérateur `~`, entre une variable réponse `y` et une ou plusieurs variables explicatives. Disons, pour simplifier, que `y` est une variable numérique, de même que `x`, et que `a` et `b` sont des variables catégorielles (des facteurs dans le langage R). Voici les principales relations auxquelles on peut s'intéresser dans un modèle statistique linéaire :

- `y ~ x` : régression linéaire simple,
- `y ~ x + 0` : idem avec suppression du terme d'ordonnée à l'origine,
- `y ~ a + b` : ANOVA avec deux effets principaux,
- `y ~ a * b` : idem avec interaction (équivalent à `1 + a + b + a:b`),
- `y ~ a / b` : idem en considérant une relation d'emboîtement (équivalent à `1 + a + b + a %in% b`).

Le package `lattice`{.pkg} ajoute les notations suivantes :

- `~ x` : dans le cas où l'on ne decrit qu'une seule variable (i.e., sa distribution),
- `a | b` : dans le cas où l'on considère la variable `a`, conditionnellement à la variable `b`, c'est-à-dire les niveaux de `a` pour chacun des niveaux de `b` (ce qui revient à l'interaction `a:b` citée ci-dessus).

Un exemple typique d'utilisation pour un modèle d'ANOVA à trois facteurs est donné ci-dessous :

```{r, eval = FALSE}
fm <- y ~ a * b* c            # modèle de base (A, B, C, AB, AC, BC, ABC)
mod1 <- aov(fm, data = dfrm)  # estimation des paramètres du modèle 
update(mod1, . ~ . -a:b:c)    # suppression de l'interaction ABC
```

## Principaux types de graphiques avec `lattice` (et `ggplot2`)


