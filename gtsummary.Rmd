---
title: "Tableaux statistiques avancés avec gtsummary"
---

```{r options_communes, include=FALSE}
source("options_communes.R")
```

L'extension `gtsummary`{.pkg} a déjà été abordée dans d'autres chapitres, notamment via les fonctions `tbl_summary`{data_pkg="gtsummary"} et `tbl_svysummary`{data_pkg="gtsummary"} dans le chapitre sur la [statistique bivariée](statistique-bivariee.html) ou la fonction `tbl_regression`{data_pkg="gtsummary"} dans le chapitre sur la [régression logistique](regression-logistique.html).

Dans ce chapitre, nous allons explorer plus en profondeur les différentes options offertes `gtsummary`{.pkg} pour la réalisation de tableaux statistiques prêts à être publiés.

Les personnes anglophones pourront également se référer à l'excellent site de documentation du package : <https://www.danieldsjoberg.com/gtsummary/>

```{r, results='hide'}
library(gtsummary)
```


## Remarques sur les types de variables et les sélecteurs associés {#type_variables}

`gtsummary`{.pkg} permets de réaliser des tableaux statistiques combinant plusieurs variables, l'affichage des résultats pouvant dépendre du type de variables. 

Par défaut, `gtsummary`{.pkg} considère qu'une variable est **catégorielle** s'il s'agit d'un facteur, d'une variable textuelle ou d'une variable numérique ayant moins de 10 valeurs différentes.

Une variable sera considérée comme **dichotomique** (variable catégorielle à seulement deux modalités) s'il s'agit d'un vecteur logique (`TRUE`/`FALSE`), d'une variable textuelle codée `yes`/`no` ou d'une variable numérique codée `0`/`1`.

Dans les autres cas, une variable numérique sera considérée comme **continue**.

Nous verrons plus loin qu'il est possible de forcer le type d'une variable et l'existence d'autres types de variables.

`gtsummary`{.pkg} fournit des sélecteurs qui pourront être utilisés dans les options des différentes fonctions, en particulier `all_continuous`{data_pkg="gtsummary"} pour les variables continues, `all_dichotolous`{data_pkg="gtsummary"} pour les variables dichotomiques et `all_categorical`{data_pkg="gtsummary"} pour les variables catégorielles (incluant les variables dichotomiques, utiliser `all_categorical(dichotomous = FALSE)` pour sélectionner les variables catégorielles en excluant les variables dichotomiques).

Dans le cadre des tableaux présentant les résultats d'un modèle statistique, il existe en plus d'autres sélecteurs pour sélectionner certains termes spécifiques : `all_intercepts`{data_pkg="gtsummary"} (pour sélectionner seulement le ou les *intercepts* du modèle), `all_interaction`{data_pkg="gtsummary"} pour les termes d'interactions entre plusieurs variables, `all_contrasts`{data_pkg="gtsummary"} pour sélectionner les variables catégorielles codées avec un contraste particulier.

## Remarques sur la syntaxe des options

De nombreuses options des fonctions de `gtsummary`{.pkg} peuvent s'appliquer seulement à une ou certaines variables. Pour ces options-là, `gtsummary`{.pkg} attends une formule de la forme `variables concernées ~ valeur de l'option` ou bien une liste de formules ayant cette forme.

Par exemple, pour modifier l'étiquette associée à une certaine variable, on peut utiliser l'option `label` de `tbl_svysummary`{data_pkg="gtsummary"}.

```{r eval=FALSE}
tbl_summary(trial, label = age ~ "Âge")
tbl_summary(trial, label = list(age ~ "Âge", trt ~ "Traitement"))
```

`gtsummary`{.pkg} est très flexible sur la manière d'indiquer la ou les variables concernées. Il peut s'agir du nom de la variable, d'une chaîne de caractères contenant le nom de la variable, ou d'un vecteur contenant le nom de la variable. Les syntaxes ci-dessous sont ainsi équivalentes.

```{r eval=FALSE}
tbl_summary(trial, label = age ~ "Âge")
tbl_summary(trial, label = "age" ~ "Âge")
v <- "age"
tbl_summary(trial, label = v ~ "Âge")
tbl_summary(trial, label = vars(age) ~ "Âge")
```

Pour appliquer le même changement à plusieurs variables, plusieurs syntaxes sont acceptées pour lister plusieurs variables.

```{r eval=FALSE}
tbl_summary(trial, label = c("age", "trt") ~ "Une même étiquette")
tbl_summary(trial, label = c(age, trt) ~ "Une même étiquette")
tbl_summary(trial, label = vars(age, trt) ~ "Une même étiquette")
```

Il est également possible d'utiliser la syntaxe `tidyselect`{.pkg} et les sélecteurs de `tidyselect`{.pkg} comme `everything`{data-pkg="tidyselect"}, `starts_with`{data-pkg="tidyselect"}, `contains`{data-pkg="tidyselect"} ou `all_of`{data-pkg="tidyselect"}. Ces différents sélecteurs peuvent être combinés au sein d'un `c()` ou de `vars()`.

```{r eval=FALSE}
tbl_summary(trial, label = everything() ~ "Une même étiquette")
tbl_summary(trial, label = starts_with("a") ~ "Une même étiquette")
tbl_summary(trial, label = c(everything(), -age, -trt) ~ "Une même étiquette")
tbl_summary(trial, label = age:trt ~ "Une même étiquette")
```

Bien sûr, il est possible d'utiliser les sélecteurs propres à `gtsummary`{.pkg}.

```{r eval=FALSE}
tbl_summary(trial, label = all_continuous() ~ "Une même étiquette")
tbl_summary(trial, label = list(
  all_continuous() ~ "Variable continue",
  all_dichotomous() ~ "Variable dichotomique",
  all_categorical(dichotomous = FALSE) ~ "Variable catégorielle"
))
```

Enfin, si l'on ne précise rien à gauche du `~`, ce sera considéré comme équivalent à `everything()`. Les deux syntaxes ci-dessous sont donc équivalentes.

```{r eval=FALSE}
tbl_summary(trial, label = ~ "Une même étiquette")
tbl_summary(trial, label = everything() ~ "Une même étiquette")
```

## Thèmes

`gtsummary`{.pkg} fournit plusieurs fonctions préfixées `theme_gtsummary_*()` permettant de modifier l'affichage par défaut des tableaux.

La fonction `theme_gtsummary_journal`{data-pkg="gtsummary"} permets d'adopter les standards de certaines grandes revues scientifiques telles que *JAMA* (*Journal of the American Medical Association*), *The Lancet* ou encore le *NEJM* (*New England Journal of Medicine*).

Par défaut, `tbl_summarry`{data-pkg="gtsummary"} utilise la médiane et l'intervalle interquartile pour les variables continues. Si on applique `theme_gtsummary_mean_sd`{data-pkg="gtsummary"}, la moyenne et l'écart-type seront utilisés par défaut.

Le thème `theme_gtsummary_journal`{data-pkg="gtsummary"} permets de modifier la langue utilisée par défaut dans les tableaux. Les options `decimal.mark` et `big.mark` permettent de définir respectivement le séparateur de décimales et le séparateur des milliers. Ainsi, pour présenter un tableau en français, on appliquera en début de script :

```{r}
theme_gtsummary_language(language = "fr", decimal.mark = ",", big.mark = " ")
```

## Statistiques descriptives avec tbl_summary()

La fonction `tbl_summarry`{data-pkg="gtsummary"} permets de réaliser des tris à plats de plusieurs variables, éventuellement croisés selon une variable catégorielle.

On lui passe en entrée un tableaux de données (*data.frame*) et par défaut toutes les variables sont résumées.

```{r}
trial %>%
  tbl_summary()
```

### Sélection des variables (include)

La paramètre `include` permets de spécifier les variables à inclure dans le tableau (et leur ordre). On peut lui passer un vecteur de noms de variables, ou bien utiliser des sélecteurs *tidyselect* (utiliser `c()` si plusieurs sélecteurs).

```{r}
trial %>%
  tbl_summary(include = c("age", "marker", "response"))

trial %>%
  tbl_summary(include = c(age:stage, starts_with("t")))
```


### En fonction d'une seconde variable (by, add_overall)

Le paramètre `by` permets de résumer chacune des variables inclues en fonction d'une variable catégorielle.

```{r}
trial %>%
  tbl_summary(
    include = c(age, stage, response),
    by = trt
  )
```

La fonction `add_overall`{data-pkg="gtsummary"}, appliquée après `tbl_summarry`{data-pkg="gtsummary"}, permets, lorsqu'une variable `by` a été définie, de rajouter une colonne avec l'ensemble du fichier. L'option `last` permets de spécifier si l'on veut ajouter cette colonne à la droite du tableau et `col_label` permet de personnaliser le titre de la colonne (noter le recours aux `**` pour indiquer ce qui doit être affiché en gras et `{N}` qui sera remplacé par le nombre d'observations).

```{r}
trial %>%
  tbl_summary(
    include = c(age, stage, response),
    by = trt
  ) %>%
  add_overall(last = TRUE, col_label = "**Ensemble** (effectif total: {N})")
```

### Statistiques affichées (statistic, percent, sort)

Le paramètre `statistic` permets de sélectionner les statistiques à afficher pour chaque variable. On indiquera une chaîne de caractères dont les différentes statistiques seront indiquées entre accolades (`{}`).

Pour une **variable continue**, on pourra utiliser `{median}` pour la médiane, `{mean}` pour la moyenne, `{sd}` pour l'écart type, `{var}` pour la variance, `{min}` pour le minimum, `{max}` pour le maximum, ou encore `{p##}` (en remplacant `##` par un nombre entier entre 00 et 100) pour le percentile correspondant (par exemple `p25` et `p75` pour le premier et le troisième quartile). Utilisez `all_continous`{data-pkg="gtsummary"} pour sélectionner toutes les variables continues.

```{r}
trial %>%
  tbl_summary(
    include = c(age, marker),
    statistic = all_continuous() ~ "Moy. : {mean} [min-max : {min}-{max}]"
  )
```

Il est possible d'afficher des statistiques différentes pour chaque variable.

```{r}
trial %>%
  tbl_summary(
    include = c(age, marker),
    statistic = list(
      age ~ "Méd. : {median} [IQR: {p25}-{p75}]",
      marker ~ "Moy. : {mean} (ET : {sd})"
    )
  )
```

Pour les variables continues, il est également possible d'indiquer le nom d'une fonction personnalisée qui prends un vecteur et renvoie une valeur résumé. Par exemple, pour afficher la moyenne des carrés :

```{r}
moy_carres <- function(x) {
  mean(x^2, na.rm = TRUE)
}
trial %>%
  tbl_summary(
    include = marker,
    statistic = ~ "MC : {moy_carres}"
  )
```

Pour une **variable catégorielle**, les statistiques possibles sont `{n}` le nombre d'observations, `{N}` le nombre total d'observations, et `{p}` le pourcentage correspondant. Utilisez `all_categorical`{data-pkg="gtsummary"} pour sélectionner toutes les variables catégorielles.

```{r}
trial %>%
  tbl_summary(
    include = c(stage, response),
    statistic = all_categorical() ~ "{p} % ({n}/{N})"
  )
```

Il est possible, pour une variable catégorielle, de trier les modalités de la plus fréquente à la moins fréquente avec le paramètre `sort`.

```{r}
trial %>%
  tbl_summary(
    include = c(stage, response),
    sort = all_categorical() ~ "frequency"
  )
```

Lorsqu'une variable `by` est définie, on peut utiliser `percent` pour indiquer le type de pourcentages : en ligne avec `row`, en colonne avec `column` et `cell` pour les pourcentages totaux.

```{r}
trial %>%
  tbl_summary(
    include = c(stage, response),
    by = grade,
    statistic = all_categorical() ~ "{p} % ({n}/{N})",
    percent = "row"
  ) %>%
  add_overall(last = TRUE)
```

### Affichage du nom des statistiques (add_stat_label)

Lorsque l'on affiche de multiples statistiques, la liste des statistiques est regroupée dans une note de tableau qui peut vite devenir un peu confuse.

```{r}
tbl <- trial %>%
  tbl_summary(
    include = c(age, marker, grade),
    by = trt,
    statistic = list(
      age ~ "{median} [{p25}-{p75}]",
      marker ~ "{mean} ({sd})"
    )
  )
tbl
```

La fonction `add_stat_label`{data-pkg="gtsummary"} permets d'indiquer le type de statistique à côté du nom des variables ou bien dans une colonne dédiée, plutôt qu'en note de tableau.

```{r}
tbl %>% add_stat_label()
tbl %>% add_stat_label(location = "column")
```

### Forcer le type de variable (type, value)

Comme [abordé plus haut](#type_variables), `gtsummary`{.pkg} détermine automatiquement le type de chaque variable. Par défaut, la variabe `age` est traitée comme variable continue, `death` comme dichotomique (seule la valeur 1 est affichée) et `grade` comme variable catégorielle.

```{r}
trial %>%
  tbl_summary(
    include = c(grade, age, death)
    )
```

Il est cependant possible de forcer un certain type avec l'argument `type`. Précision, lorsque l'on force une variable en dichotomique, il faut indiquer avec `value` la valeur à afficher (les autres sont alors masquées).

```{r}
trial %>%
  tbl_summary(
    include = c(grade, age, death),
    type = list(
      grade ~ "dichotomous",
      age ~ "categorical",
      death ~ "categorical"
    ),
    value = grade ~ "III",
    label = grade ~ "Grade III"
  )
```


### Afficher des statistiques sur plusieurs lignes (continuous2)

Pour les variables continues, `gtsummary`{.pkg} a introduit un type de variable `"continuous2"`, qui doit être attribué manuellement via `type`, et qui permets d'afficher plusieurs lignes de statistiques (en indiquant plusieurs chaînes de caractères dans `statistic`).

```{r}
trial %>%
  tbl_summary(
    include = c(age, marker, ttdeath),
    type = c(age, marker) ~ "continuous2",
    statistic = all_continuous2() ~ c("{median} ({p25} - {p75}", "{mean} ({sd})", "{min} - {max}")
  )
```

### Mise en forme des statistiques (digits)

### Données manquantes (missing, missing_text)

### Étiquettes des variables (label)

aborder aussi labelled::var_label

### Afficher les effectifs (add_n)


### Mise en forme du tableau (bold_labels, italicize_levels)


### Tests de comparaisons (add_p, add_q, separate_p_footnotes)




### Intervalles de confiance (add_ci)


### Différences entre groupes (add_difference)


## Tableau croisé avec tbl_cross()


## Données pondérées et tbl_svysummary()


## Statistiques personnalisées avec tbl_continous() et tbl_custom_summary()

### tbl_continuous()

### tbl_custom_summary()

### add_stat()

## Résultats d'un modèle avec tbl_regression()

include et label générique

### Exponentiation des coefficients (exponentiate)

### Afficher des étoiles de signification (add_significance_stars)

### Variables dichotomiques sur une ligne (show_single_row)

### Afficher l'intercept (intercept)

### Mise en forme des coefficients (estimate_fun, pvalue_fun)

### Afficher les coefficients pour les références (add_estimate_to_reference_rows)

### P-valeurs globales (add_global_p)

### Ajouter les VIF (add_vif)

### Représenter graphiquement le modèle (plot)

### Afficher des statistiques globales du modèle (add_glance_table, add_glance_source_note)

## Régressions univariées multiples avec tbl_uvregression()

## Tables de survie avec tbl_survfit()

## Modifier un tableau

### Modifier les titres de colonne (modify_header)

### Afficher/Masquer une colonne (modify_column_hide, modify_column_unhide)

### Ajouter un titre global (modify_caption)

### Regrouper des colonnes (modify_spanning_header)

### Modifier les notes (modify_footnote)

## Combiner des tableaux

### tbl_stack()

### tbl_merge()

### tbl_strata()


### tbl_split()




## Exporter un tableau

![Formats d'export d'un tableau gtsummary](images/gtsummary_output_formats.png)

```{r, eval=FALSE}
tbl %>%
  as_gt() %>%
  gt::gtsave(filename = ".") # use extensions .html .tex .ltx .rtf

tbl %>%
  as_flex_table() %>%
  flextable::save_as_docx()
```



## Plus d'options avec bstfun

### tbl_likert()

### Ajouter un graphique de tendances (add_sparkline)

### Représentation graphique des coefficients dans le tableau (add_inline_forest_plot)

### Forest plot (as_forest_plot)
